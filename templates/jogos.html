<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Jogos</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-graduation-cap"></i>
          FADU
        </a>

        <div class="ml-auto">
          <select class="nav-select" onchange="navigateToPage(this.value)">
            <option value="">‚Äî Selecionar Vista ‚Äî</option>
            <option value="/Uni">üèõÔ∏è Universidades</option>
            <option value="/Ass">üèÜ Associa√ß√µes</option>
            <option value="/Jogos" selected>‚öΩ Jogos</option>
            <option value="/Fases">üìÖ Fases</option>
            <option value="/Inscritos">üë§ Inscritos</option>
          </select>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="main-container fade-in">
        <div class="page-header">
          <h1 class="page-title">
            <i class="fas fa-futbol"></i>
            Jogos
          </h1>
          <div class="text-muted">
            <i class="fas fa-info-circle"></i>
            Gerir informa√ß√µes dos Jogos
          </div>
        </div>

        <div class="filter-section" id="filterSection">
          <div class="filter-header" onclick="toggleFilters()">
            <h3 class="filter-title">
              <i class="fas fa-filter"></i>
              Filtros Avan√ßados
            </h3>
            <button class="filter-toggle" id="filterToggle">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="filter-content" id="filterContent">
            <!-- Active Filters Display -->
            <div class="active-filters" id="activeFilters" style="display: none">
              <strong><i class="fas fa-tags mr-2"></i>Filtros Ativos:</strong>
              <div class="active-filter-tags" id="activeFilterTags"></div>
            </div>

            <!-- Filter Form -->
            <form id="filterForm">
              <div class="filter-row">
                <div class="filter-group">
                  <label class="filter-label">
                    <i class="fas fa-calendar"></i>
                    Data do Jogo
                  </label>
                  <input
                    type="date"
                    id="filterGameDate"
                    name="game_date"
                    class="filter-input"
                  />
                </div>

                <div class="filter-group">
                  <label class="filter-label">
                    <i class="fas fa-trophy"></i>
                    Modalidade
                  </label>
                  <select id="filterSport" name="sport" class="filter-select">
                    <option value="">Todas as Modalidades</option>
                    <option value="Futebol">Futebol</option>
                    <option value="Basquetebol">Basquetebol</option>
                    <option value="Voleibol">Voleibol</option>
                    <option value="Andebol">Andebol</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label class="filter-label">
                    <i class="fas fa-flag"></i>
                    Fase
                  </label>
                  <select id="filterPhase" name="phase" class="filter-select">
                    <option value="">Todas as Fases</option>
                    <option value="Grupos">Grupos</option>
                    <option value="Oitavos">Oitavos</option>
                    <option value="Quartos">Quartos</option>
                    <option value="Meias">Meias</option>
                    <option value="Final">Final</option>
                  </select>
                </div>
              </div>

              <div class="filter-row">
                <div class="filter-group">
                  <label class="filter-label">
                    <i class="fas fa-sort"></i>
                    Ordenar Por
                  </label>
                  <select id="filterSortBy" name="sort_by" class="filter-select">
                    <option value="">Ordem Padr√£o</option>
                    <optgroup label="Data">
                      <option value="date_asc">Mais Antigo</option>
                      <option value="date_desc">Mais Recente</option>
                    </optgroup>
                    <optgroup label="Modalidade">
                      <option value="sport_asc">A-Z</option>
                      <option value="sport_desc">Z-A</option>
                    </optgroup>
                    <optgroup label="Fase">
                      <option value="phase_asc">A-Z</option>
                      <option value="phase_desc">Z-A</option>
                    </optgroup>
                  </select>
                </div>
              </div>

              <div class="filter-actions">
                <button type="button" class="btn-filter btn-clear-filter" onclick="clearFilters()">
                  <i class="fas fa-times"></i>
                  Limpar Filtros
                </button>
                <button type="submit" class="btn-filter btn-apply-filter">
                  <i class="fas fa-search"></i>
                  Aplicar Filtros
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="Pesquisar jogo por modalidade, fase ou equipas..."
            />
          </div>
        </div>

        <div class="table-container">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  {% for col in columns %}
                  <th><i class="fas fa-info-circle mr-2"></i>{{ col }}</th>
                  {% endfor %}
                  <th><i class="fas fa-cogs mr-2"></i>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rows %}
                <tr>
                  {% for cell in row %}
                  <td>{{ cell }}</td>
                  {% endfor %}
                  <td>
                    <a href="#" class="view-game" data-id="{{ row[0] }}" title="Ver Detalhes">
                      <i class="fas fa-eye"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      function navigateToPage(url) {
        if (url && url !== "#") {
          window.location.href = url;
        }
      }

      document.addEventListener("click", function (e) {
        if (e.target.closest(".view-game")) {
          e.preventDefault();
          const gameId = e.target.closest(".view-game").getAttribute("data-id");
          window.location.href = `/Jogos/${gameId}`;
        }
      });

      // Filter functionality
      function toggleFilters() {
        const filterContent = document.getElementById("filterContent");
        const filterToggle = document.getElementById("filterToggle");
        
        if (filterContent.style.display === "none") {
          filterContent.style.display = "block";
          filterToggle.innerHTML = '<i class="fas fa-chevron-up"></i>';
        } else {
          filterContent.style.display = "none";
          filterToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
        }
      }

      function clearFilters() {
        document.getElementById("filterForm").reset();
        document.getElementById("activeFilters").style.display = "none";
        document.getElementById("activeFilterTags").innerHTML = "";
        applyFilters();
      }

      function getFilterLabel(key) {
        const labels = {
          game_date: "Data",
          sport: "Modalidade",
          phase: "Fase",
          sort_by: "Ordena√ß√£o"
        };
        return labels[key] || key;
      }

      function getFilterValue(key, value) {
        const valueLabels = {
          date_asc: "Data (Mais Antigo)",
          date_desc: "Data (Mais Recente)",
          sport_asc: "Modalidade (A-Z)",
          sport_desc: "Modalidade (Z-A)",
          phase_asc: "Fase (A-Z)",
          phase_desc: "Fase (Z-A)"
        };
        return valueLabels[value] || value;
      }

      function removeFilter(key) {
        const input = document.querySelector(`[name="${key}"]`);
        if (input) {
          input.value = "";
          updateActiveFilters();
          applyFilters();
        }
      }

      function applyFilters() {
        const form = document.getElementById("filterForm");
        const formData = new FormData(form);
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const tableRows = document.querySelectorAll("tbody tr");
        const tbody = document.querySelector("tbody");
        const rows = Array.from(tableRows);

        // First apply sorting
        const sortBy = formData.get("sort_by");
        if (sortBy) {
          rows.sort((a, b) => {
            let aValue, bValue;
            
            switch(sortBy) {
              case "date_asc":
              case "date_desc":
                aValue = a.querySelector("td:nth-child(2)")?.textContent || "";
                bValue = b.querySelector("td:nth-child(2)")?.textContent || "";
                break;
              case "sport_asc":
              case "sport_desc":
                aValue = a.querySelector("td:nth-child(3)")?.textContent || "";
                bValue = b.querySelector("td:nth-child(3)")?.textContent || "";
                break;
              case "phase_asc":
              case "phase_desc":
                aValue = a.querySelector("td:nth-child(4)")?.textContent || "";
                bValue = b.querySelector("td:nth-child(4)")?.textContent || "";
                break;
              default:
                return 0;
            }

            if (sortBy.endsWith("_desc")) {
              return bValue.localeCompare(aValue);
            }
            return aValue.localeCompare(bValue);
          });

          // Reorder rows in the DOM
          rows.forEach(row => tbody.appendChild(row));
        }

        // Then apply filters
        rows.forEach(row => {
          const rowData = row.textContent.toLowerCase();
          let shouldShow = true;

          // Apply search filter
          if (searchTerm && !rowData.includes(searchTerm)) {
            shouldShow = false;
          }

          // Apply date filter
          const gameDate = formData.get("game_date");
          if (gameDate) {
            const rowDate = row.querySelector("td:nth-child(2)")?.textContent;
            if (rowDate && rowDate !== gameDate) {
              shouldShow = false;
            }
          }

          // Apply sport filter
          const sport = formData.get("sport");
          if (sport) {
            const rowSport = row.querySelector("td:nth-child(3)")?.textContent;
            if (rowSport && !rowSport.toLowerCase().includes(sport.toLowerCase())) {
              shouldShow = false;
            }
          }

          // Apply phase filter
          const phase = formData.get("phase");
          if (phase) {
            const rowPhase = row.querySelector("td:nth-child(4)")?.textContent;
            if (rowPhase && !rowPhase.toLowerCase().includes(phase.toLowerCase())) {
              shouldShow = false;
            }
          }

          row.style.display = shouldShow ? "" : "none";
        });

        updateActiveFilters();
      }

      function updateActiveFilters() {
        const activeFilters = document.getElementById("activeFilters");
        const activeFilterTags = document.getElementById("activeFilterTags");
        const form = document.getElementById("filterForm");
        const formData = new FormData(form);
        
        let hasActiveFilters = false;
        activeFilterTags.innerHTML = "";

        for (let [key, value] of formData.entries()) {
          if (value) {
            hasActiveFilters = true;
            const tag = document.createElement("span");
            tag.className = "filter-tag";
            const displayValue = key === "sort_by" ? getFilterValue(key, value) : value;
            tag.innerHTML = `${getFilterLabel(key)}: ${displayValue} <i class="fas fa-times" onclick="removeFilter('${key}')"></i>`;
            activeFilterTags.appendChild(tag);
          }
        }

        activeFilters.style.display = hasActiveFilters ? "block" : "none";
      }

      // Initialize filters
      document.addEventListener("DOMContentLoaded", function() {
        const filterForm = document.getElementById("filterForm");
        
        // Add change event listeners to all filter inputs
        const filterInputs = filterForm.querySelectorAll("input, select");
        filterInputs.forEach(input => {
          input.addEventListener("change", function() {
            applyFilters();
          });
        });

        // Set initial filter content display
        document.getElementById("filterContent").style.display = "none";

        // Search functionality
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function(e) {
          applyFilters();
        });
      });
    </script>
  </body>
</html>
